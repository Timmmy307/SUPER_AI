<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Assistant</title>
<style>
  :root{
    color-scheme: light dark;
    --bg: #0b0c10; --panel:#0f1117; --text:#e6e8ef; --muted:#a3a8b6;
    --border:#262b3a; --accent:#8aa2ff; --danger:#ff6b6b; --ok:#34d399;
    --bgL:#f6f7fb; --panelL:#ffffff; --textL:#0f1117; --mutedL:#5e6472; --borderL:#e5e7ef;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font:14px ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
    display:grid; grid-template-columns:280px 1fr; grid-template-rows:56px 1fr 92px;
    grid-template-areas:
      "side head"
      "side main"
      "side composer";
    overflow:hidden;
    background:var(--bg); color:var(--text);
  }
  body.light{ background:var(--bgL); color:var(--textL); }
  a{color:inherit}

  /* header */
  header{
    grid-area:head; height:56px; display:flex; align-items:center; justify-content:space-between;
    padding:0 12px; border-bottom:1px solid var(--border); background:linear-gradient(180deg,#0f1117,#0b0c10);
  }
  body.light header{ background:linear-gradient(180deg,#fff,#f6f7fb); border-color:var(--borderL); }
  .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.2px}
  .logo{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:#141826 center/cover no-repeat;}
  body.light .logo{border-color:var(--borderL)}
  .actions{display:flex;gap:8px}
  .btn{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.ghost{background:transparent}
  .btn.danger{background:#36151b;border-color:#6e1d1d;color:#fff}
  body.light .btn{background:var(--panelL);color:var(--textL);border-color:var(--borderL)}
  body.light .btn.danger{color:#fff}

  /* sidebar */
  aside{
    grid-area:side; border-right:1px solid var(--border); background:#0e1016; display:flex;flex-direction:column;
  }
  body.light aside{ background:#f9fafe; border-color:var(--borderL) }
  .side-head{padding:10px;border-bottom:1px solid var(--border);display:flex;gap:6px;align-items:center}
  body.light .side-head{border-color:var(--borderL)}
  .side-head .btn{width:100%}
  .chats{flex:1;overflow:auto;padding:8px}
  .chat-item{padding:10px;border:1px solid var(--border);border-radius:10px;margin:8px 4px;background:var(--panel);cursor:pointer}
  .chat-item.active{outline:2px solid var(--accent)}
  body.light .chat-item{background:var(--panelL);border-color:var(--borderL)}

  /* main chat */
  main{ grid-area:main; display:flex; flex-direction:column; overflow:hidden }
  #scroll{flex:1;overflow:auto;padding:16px 0;display:flex;justify-content:center}
  .col{width:min(860px,100%);padding:0 8px}
  .msg{border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin:10px 0;background:#12141b}
  .msg.user{background:#17212b;border-color:#2a415c}
  .msg.assistant{background:#151822;border-color:#2a2f45}
  body.light .msg{background:var(--panelL);border-color:var(--borderL)}
  body.light .msg.user{background:#eef6ff;border-color:#cfe3ff}
  body.light .msg.assistant{background:#f5f6fb;border-color:#e9eaf4}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  body.light .meta{color:var(--mutedL)}

  /* composer */
  #composer{ grid-area:composer; border-top:1px solid var(--border); background:linear-gradient(180deg,#0f1117,#0b0c10); padding:12px }
  body.light #composer{ background:linear-gradient(180deg,#fff,#f6f7fb); border-color:var(--borderL) }
  .row{width:min(860px,100%);margin:0 auto;display:flex;gap:8px;align-items:flex-end}
  textarea{flex:1;resize:none;min-height:48px;max-height:180px;border:1px solid var(--border);border-radius:14px;padding:12px 14px;background:var(--panel);color:var(--text);outline:none}
  body.light textarea{background:var(--panelL);color:var(--textL);border-color:var(--borderL)}
  .iconbtn{width:42px;height:42px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);display:grid;place-items:center;cursor:pointer}
  body.light .iconbtn{background:var(--panelL);color:var(--textL);border-color:var(--borderL)}
  .iconbtn.rec{outline:2px solid var(--danger)}
  .send{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel);cursor:pointer;color:#fff}
  body.light .send{color:#000; background:var(--panelL); border-color:var(--borderL)}
  body:not(.light) .send{color:#fff}

  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:20}
  .card{background:#0f1117;border:1px solid var(--border);border-radius:12px;padding:16px;min-width:360px;max-width:620px}
  body.light .card{background:#fff;border-color:var(--borderL)}
  .card h3{margin:0 0 10px}
</style>
</head>
<body>
  <aside>
    <div class="side-head">
      <button id="newChat" class="btn">+ New chat</button>
    </div>
    <div id="chats" class="chats"></div>
    <div style="padding:8px;border-top:1px solid var(--border)">
      <button id="openSettings" class="btn" style="width:100%">Settings</button>
    </div>
  </aside>

  <header>
    <div class="brand">
      <div id="logo" class="logo"></div>
      <div>Assistant</div>
      <label class="btn ghost" style="margin-left:6px">
        Upload logo <input id="logoFile" type="file" accept="image/*" style="display:none" />
      </label>
    </div>
    <div class="actions">
      <button id="stopBtn" class="btn danger">Stop</button>
    </div>
  </header>

  <main>
    <div id="scroll"><div class="col" id="log"></div></div>
  </main>

  <section id="composer">
    <div class="row">
      <button id="mic" class="iconbtn" title="Talk mode toggle">üéôÔ∏è</button>
      <textarea id="prompt" placeholder="Message‚Ä¶"></textarea>
      <button id="send" class="send">Send</button>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:6px">
      <small id="status" style="opacity:.8"></small>
    </div>
  </section>

  <!-- Settings Modal (also contains Owner tools) -->
  <div id="settings" class="modal">
    <div class="card">
      <h3>Settings</h3>
      <div class="row" style="margin-top:6px">
        <label style="width:140px">Model</label>
        <input id="model" value="llama-3.3-70b-versatile" style="flex:1">
      </div>
      <div class="row" style="margin-top:6px">
        <label style="width:140px">Voice</label>
        <select id="voice" style="flex:1">
          <option>Fritz-PlayAI</option><option>Celeste-PlayAI</option><option>Quinn-PlayAI</option>
          <option>Gail-PlayAI</option><option>Mason-PlayAI</option><option>Atlas-PlayAI</option>
        </select>
      </div>
      <div class="row" style="margin-top:6px">
        <label style="width:140px">User Agent</label>
        <input id="ua" value="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36" style="flex:1">
      </div>
      <hr style="border:0;border-top:1px solid var(--border);margin:10px 0">
      <h3>Owner</h3>
      <div class="row" style="margin-top:6px">
        <label style="width:140px">Owner password</label>
        <input id="ownerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="flex:1">
      </div>
      <div class="row" style="margin-top:6px">
        <input id="cmd" placeholder="echo hello" style="flex:1">
        <button id="runCmd" class="btn">Run</button>
      </div>
      <div class="row" style="margin-top:6px">
        <input id="editFile" placeholder="server.js or index.html" style="flex:1">
        <button id="saveFile" class="btn">Save file</button>
      </div>
      <pre id="cmdOut" style="white-space:pre-wrap;max-height:160px;overflow:auto;margin-top:6px"></pre>
      <div class="row" style="justify-content:flex-end; gap:8px; margin-top:10px">
        <button id="testTTS" class="btn">Test voice</button>
        <button id="closeSettings" class="btn">Close</button>
      </div>
      <div id="note" class="status"></div>
    </div>
  </div>

<script>
// --- theme auto-detect with dark fallback
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
if (!prefersDark) document.body.classList.add('light');

// --- elements
const logEl = document.getElementById('log');
const promptEl = document.getElementById('prompt');
const sendBtn = document.getElementById('send');
const micBtn = document.getElementById('mic');
const stopBtn = document.getElementById('stopBtn');
const statusEl = document.getElementById('status');
const openSettings = document.getElementById('openSettings');
const settingsModal = document.getElementById('settings');
const closeSettings = document.getElementById('closeSettings');
const modelEl = document.getElementById('model');
const voiceEl = document.getElementById('voice');
const uaEl = document.getElementById('ua');
const ownerPasswordSetting = document.getElementById('ownerPassword');
const testTTS = document.getElementById('testTTS');
const cmdEl = document.getElementById('cmd');
const cmdOut = document.getElementById('cmdOut');
const runCmdBtn = document.getElementById('runCmd');
const editFileEl = document.getElementById('editFile');
const saveFileBtn = document.getElementById('saveFile');
const newChatBtn = document.getElementById('newChat');
const chatsEl = document.getElementById('chats');
const logo = document.getElementById('logo');
const logoFile = document.getElementById('logoFile');

// --- local state
let talkMode = false; // off by default
let controller = null;
let messages = [];
let currentChatId = null;

// --- logo upload (stored as object URL)
logoFile.onchange = () => {
  const f = logoFile.files?.[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  logo.style.backgroundImage = `url(${url})`;
  localStorage.setItem('assistantLogo', url);
};
const savedLogo = localStorage.getItem('assistantLogo');
if (savedLogo) logo.style.backgroundImage = `url(${savedLogo})`;

// --- settings persistence
const S = JSON.parse(localStorage.getItem('uiSettings') || '{}');
if (S.model) modelEl.value = S.model;
if (S.voice) voiceEl.value = S.voice;
if (S.ua) uaEl.value = S.ua;
if (S.ownerPassword) ownerPasswordSetting.value = S.ownerPassword;

function saveSettings(){
  const obj = { model:modelEl.value, voice:voiceEl.value, ua:uaEl.value, ownerPassword:ownerPasswordSetting.value };
  localStorage.setItem('uiSettings', JSON.stringify(obj));
  note('Saved');
}
function note(t){ const el=document.getElementById('note'); el.textContent=t; setTimeout(()=>el.textContent='',1200); }
openSettings.onclick = ()=> settingsModal.style.display='flex';
closeSettings.onclick = ()=> { settingsModal.style.display='none'; saveSettings(); };
testTTS.onclick = async ()=>{
  saveSettings();
  try{
    const r = await fetch('/api/tts', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ text:`Hi! This is ${voiceEl.value}.`, voice: voiceEl.value }) });
    const buf = await r.arrayBuffer();
    const url = URL.createObjectURL(new Blob([buf], {type:'audio/wav'}));
    new Audio(url).play().catch(()=>{});
  }catch{ toast('TTS failed'); }
};

// --- chats in localStorage
function renderChats(){
  const all = JSON.parse(localStorage.getItem('groqChats') || '[]');
  chatsEl.innerHTML = '';
  all.forEach(c => {
    const div = document.createElement('div');
    div.className = 'chat-item' + (c.id===currentChatId?' active':'');
    div.textContent = c.title || 'New chat';
    div.onclick = ()=>loadChat(c.id);
    chatsEl.appendChild(div);
  });
  if (!currentChatId && all[0]) loadChat(all[0].id);
}
function loadChat(id){
  const all = JSON.parse(localStorage.getItem('groqChats') || '[]');
  const chat = all.find(c=>c.id===id);
  if (!chat) return;
  currentChatId = chat.id;
  messages = chat.messages || [];
  logEl.innerHTML='';
  for (const m of messages) addMsg(m.role, m.content);
  renderChats();
}
function saveChat(){
  const all = JSON.parse(localStorage.getItem('groqChats') || '[]');
  const idx = all.findIndex(c=>c.id===currentChatId);
  const title = (messages.find(m=>m.role==='user')?.content || 'New chat').slice(0,48);
  const record = { id: currentChatId, title, messages };
  if (idx>=0) all[idx]=record; else all.push(record);
  localStorage.setItem('groqChats', JSON.stringify(all));
  renderChats();
}
newChatBtn.onclick = ()=>{
  currentChatId = 'c_'+Math.random().toString(36).slice(2);
  messages = [];
  logEl.innerHTML='';
  saveChat();
};
renderChats();

// --- UI helpers
function addMsg(role, content){
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + role;
  wrap.innerHTML = `<div class="meta">${role}</div>${escapeHtml(content)}`;
  logEl.appendChild(wrap);
  document.getElementById('scroll').scrollTop = logEl.parentElement.scrollHeight;
  return wrap;
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}
function toast(t){ statusEl.textContent=t; setTimeout(()=>statusEl.textContent='',2600); }

// --- send + streaming
sendBtn.onclick = ()=>send(promptEl.value);
promptEl.onkeydown = e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(promptEl.value);} };

async function send(text){
  if(!text.trim()) return;
  if (!currentChatId) newChatBtn.click();
  addMsg('user', text);
  messages.push({ role:'user', content:text });
  saveChat();
  promptEl.value='';

  // streaming bubble
  const bubble = addMsg('assistant', '');
  controller = new AbortController();
  try{
    const resp = await fetch('/api/chat-stream', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ messages, model: modelEl.value }),
      signal: controller.signal
    });
    const reader = resp.body.getReader();
    const dec = new TextDecoder();
    let acc = '';
    while(true){
      const {value, done} = await reader.read();
      if (done) break;
      const chunk = dec.decode(value);
      acc += chunk;
      bubble.innerHTML = `<div class="meta">assistant</div>${escapeHtml(acc)}`;
      document.getElementById('scroll').scrollTop = logEl.parentElement.scrollHeight;
    }
    messages.push({ role:'assistant', content: acc });
    saveChat();

    // talk mode: speak response
    if (talkMode && acc){
      try{
        const t = await fetch('/api/tts', { method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ text: acc, voice: voiceEl.value }) });
        const buf = await t.arrayBuffer();
        const url = URL.createObjectURL(new Blob([buf], {type:'audio/wav'}));
        const a = new Audio(url); a.play().catch(()=>{});
      }catch{}
    }
  }catch(e){
    bubble.innerHTML = `<div class="meta">assistant</div>Error: ${escapeHtml(e.message)}`;
  }finally{
    controller = null;
  }
}

// --- talk mode button (toggle)
micBtn.onclick = ()=>{
  talkMode = !talkMode;
  micBtn.classList.toggle('rec', talkMode);
  toast(talkMode ? 'Talk mode ON' : 'Talk mode OFF');
  if (talkMode){ startSTTLoop(); }
};

// STT loop: capture voice, transcribe, send, repeat
async function startSTTLoop(){
  if (!talkMode) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    const rec = new MediaRecorder(stream, { mimeType:'audio/webm' });
    const chunks = [];
    rec.ondataavailable = e=>chunks.push(e.data);
    rec.onstop = async ()=>{
      const blob = new Blob(chunks,{type:'audio/webm'});
      const form = new FormData(); form.append('audio', blob, 'input.webm');
      const r = await fetch('/api/stt', { method:'POST', body: form }).then(r=>r.json()).catch(()=>({}));
      const txt = r?.text || '';
      stream.getTracks().forEach(t=>t.stop());
      if (txt.trim()) await send(txt);
      if (talkMode) startSTTLoop();
    };
    rec.start();
    toast('Listening‚Ä¶');
    setTimeout(()=>{ if(rec.state!=='inactive') rec.stop(); }, 8000);
  }catch(e){
    toast('Mic error: '+e.message);
    talkMode=false; micBtn.classList.remove('rec');
  }
}

// --- stop
stopBtn.onclick = ()=>{ if (controller){ controller.abort(); toast('Stopped'); } };

// --- Owner functions in settings modal
runCmdBtn.onclick = async ()=>{
  const password = ownerPasswordSetting.value || '';
  const command = cmdEl.value;
  const r = await fetch('/api/exec', { method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ password, command }) }).then(r=>r.json()).catch(e=>({error:String(e)}));
  cmdOut.textContent = r?.error ? ('Error: '+r.error + (r.details?('\n'+JSON.stringify(r.details)):'')) :
    ((r.stdout||'') + (r.stderr?('\n[stderr]\n'+r.stderr):''));
};
saveFileBtn.onclick = async ()=>{
  const password = ownerPasswordSetting.value || '';
  const filename = (editFileEl.value||'').trim();
  if (!filename){ cmdOut.textContent='Enter filename: server.js or index.html'; return; }
  const existing = await fetch(filename).then(r=>r.text()).catch(()=> '');
  const content = prompt('Paste new contents for '+filename, existing);
  if (content==null) return;
  const r = await fetch('/api/self-edit', { method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ password, filename, content }) }).then(r=>r.json()).catch(e=>({error:String(e)}));
  cmdOut.textContent = r?.ok ? (filename+' saved. Restart to apply.') : ('Save error: '+(r?.error||'unknown'));
};
</script>
</body>
</html>
